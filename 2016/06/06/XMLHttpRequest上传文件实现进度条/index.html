<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>XMLHttpRequest上传文件实现进度条 | 杨洋洋的个人博客 | 假装不是程序猿</title>

  
  <meta name="author" content="yangyangyang">
  

  
  <meta name="description" content="假装不是程序猿">
  

  
  
  <meta name="keywords" content="XMLHttpRequest">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="XMLHttpRequest上传文件实现进度条"/>

  <meta property="og:site_name" content="杨洋洋的个人博客"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="杨洋洋的个人博客" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">杨洋洋的个人博客</a>
    </h1>
    <p class="site-description">假装不是程序猿</p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives">归档</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>XMLHttpRequest上传文件实现进度条</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2016/06/06/XMLHttpRequest上传文件实现进度条/" rel="bookmark">
        <time class="entry-date published" datetime="2016-06-06T01:23:11.000Z">
          2016-06-06
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h3 id="XMLHttpRequest上传文件实现进度条"><a href="#XMLHttpRequest上传文件实现进度条" class="headerlink" title="XMLHttpRequest上传文件实现进度条"></a><center>XMLHttpRequest上传文件实现进度条</center></h3><hr>
<p>XMLHttpRequest对象，传送数据的时候，有一个progress事件，用来返回进度信息。它分成上传和下载两种情况<br>１. 下载的progress事件属于XMLHttpRequest对象<br>２. 上传的progress事件属于XMLHttpRequest.upload对象。<br><a id="more"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div></pre></td><td class="code"><pre><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">&lt;meta charset=&quot;UTF-8&quot;&gt;</div><div class="line">    &lt;title&gt;XMLHttpRequest上传文件进度实现&lt;/title&gt;</div><div class="line">    &lt;script type=&quot;text/javascript&quot;&gt;</div><div class="line">        var xhr;</div><div class="line">        var ot;//</div><div class="line">        var oloaded;</div><div class="line">        //上传文件方法</div><div class="line">        function UpladFile() &#123;</div><div class="line">            var fileObj = document.getElementById(&quot;file&quot;).files[0]; // js 获取文件对象</div><div class="line">            var url = &quot;uploadFile&quot;; // 接收上传文件的后台地址 </div><div class="line">            </div><div class="line">            var form = new FormData(); // FormData 对象</div><div class="line">            form.append(&quot;mf&quot;, fileObj); // 文件对象</div><div class="line">            </div><div class="line">            xhr = new XMLHttpRequest();  // XMLHttpRequest 对象</div><div class="line">            xhr.open(&quot;post&quot;, url, true); //post方式，url为服务器请求地址，true 该参数规定请求是否异步处理。</div><div class="line">            xhr.onload = uploadComplete; //请求完成</div><div class="line">            xhr.onerror =  uploadFailed; //请求失败</div><div class="line">            xhr.upload.onprogress = progressFunction;//【上传进度调用方法实现】</div><div class="line">            xhr.upload.onloadstart = function()&#123;//上传开始执行方法</div><div class="line">                ot = new Date().getTime();   //设置上传开始时间</div><div class="line">                oloaded = 0;//设置上传开始时，以上传的文件大小为0</div><div class="line">            &#125;;</div><div class="line">            xhr.send(form); //开始上传，发送form数据</div><div class="line">        &#125;</div><div class="line">        //上传进度实现方法，上传过程中会频繁调用该方法</div><div class="line">        function progressFunction(evt) &#123;</div><div class="line">            </div><div class="line">             var progressBar = document.getElementById(&quot;progressBar&quot;);</div><div class="line">             var percentageDiv = document.getElementById(&quot;percentage&quot;);</div><div class="line">             // event.total是需要传输的总字节，event.loaded是已经传输的字节。如果event.lengthComputable不为真，则event.total等于0</div><div class="line">             if (evt.lengthComputable) &#123;//</div><div class="line">                 progressBar.max = evt.total;</div><div class="line">                 progressBar.value = evt.loaded;</div><div class="line">                 percentageDiv.innerHTML = Math.round(evt.loaded / evt.total * 100) + &quot;%&quot;;</div><div class="line">             &#125;</div><div class="line">            </div><div class="line">            var time = document.getElementById(&quot;time&quot;);</div><div class="line">            var nt = new Date().getTime();//获取当前时间</div><div class="line">            var pertime = (nt-ot)/1000; //计算出上次调用该方法时到现在的时间差，单位为s</div><div class="line">            ot = new Date().getTime(); //重新赋值时间，用于下次计算</div><div class="line">            </div><div class="line">            var perload = evt.loaded - oloaded; //计算该分段上传的文件大小，单位b       </div><div class="line">            oloaded = evt.loaded;//重新赋值已上传文件大小，用以下次计算</div><div class="line">        </div><div class="line">            //上传速度计算</div><div class="line">            var speed = perload/pertime;//单位b/s</div><div class="line">            var bspeed = speed;</div><div class="line">            var units = &apos;b/s&apos;;//单位名称</div><div class="line">            if(speed/1024&gt;1)&#123;</div><div class="line">                speed = speed/1024;</div><div class="line">                units = &apos;k/s&apos;;</div><div class="line">            &#125;</div><div class="line">            if(speed/1024&gt;1)&#123;</div><div class="line">                speed = speed/1024;</div><div class="line">                units = &apos;M/s&apos;;</div><div class="line">            &#125;</div><div class="line">            speed = speed.toFixed(1);</div><div class="line">            //剩余时间</div><div class="line">            var resttime = ((evt.total-evt.loaded)/bspeed).toFixed(1);</div><div class="line">            time.innerHTML = &apos;，速度：&apos;+speed+units+&apos;，剩余时间：&apos;+resttime+&apos;s&apos;;</div><div class="line">               if(bspeed==0)</div><div class="line">                time.innerHTML = &apos;上传已取消&apos;;</div><div class="line">        &#125;</div><div class="line">        //上传成功响应</div><div class="line">        function uploadComplete(evt) &#123;</div><div class="line">         //服务断接收完文件返回的结果</div><div class="line">         //    alert(evt.target.responseText);</div><div class="line">             alert(&quot;上传成功！&quot;);</div><div class="line">        &#125;</div><div class="line">        //上传失败</div><div class="line">        function uploadFailed(evt) &#123;</div><div class="line">            alert(&quot;上传失败！&quot;);</div><div class="line">        &#125;</div><div class="line">          //取消上传</div><div class="line">        function cancleUploadFile()&#123;</div><div class="line">            xhr.abort();</div><div class="line">        &#125;</div><div class="line">    &lt;/script&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">    &lt;progress id=&quot;progressBar&quot; value=&quot;0&quot; max=&quot;100&quot; style=&quot;width: 300px;&quot;&gt;&lt;/progress&gt;</div><div class="line">    &lt;span id=&quot;percentage&quot;&gt;&lt;/span&gt;&lt;span id=&quot;time&quot;&gt;&lt;/span&gt;</div><div class="line">    &lt;br /&gt;&lt;br /&gt;</div><div class="line">    &lt;input type=&quot;file&quot; id=&quot;file&quot; name=&quot;myfile&quot; /&gt;</div><div class="line">    &lt;input type=&quot;button&quot; onclick=&quot;UpladFile()&quot; value=&quot;上传&quot; /&gt;</div><div class="line">    &lt;input type=&quot;button&quot; onclick=&quot;cancleUploadFile()&quot; value=&quot;取消&quot; /&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>若想用jQuery 中的ajax实现的话，jQuery的 ajax 方法没有关于 progress 事件的操作，此时需要调用的XMLHttpRequest对象是指定progress 事件。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">$.ajax(&#123;</div><div class="line">    type: &quot;POST&quot;,</div><div class="line">　　url: &quot;upload&quot;,</div><div class="line">　　data: formData ,　　//这里上传的数据使用了formData 对象</div><div class="line">　　processData : false, </div><div class="line">　　//必须false才会自动加上正确的Content-Type </div><div class="line">　　contentType : false , </div><div class="line">　　　　</div><div class="line">　　//这里我们先拿到jQuery产生的 XMLHttpRequest对象，为其增加 progress 事件绑定，然后再返回交给ajax使用</div><div class="line">　　xhr: function()&#123;</div><div class="line">　　　　var xhr = $.ajaxSettings.xhr();</div><div class="line">　　　　if(onprogress &amp;&amp; xhr.upload) &#123;</div><div class="line">　　　　　　xhr.upload.onprogress = progressFunction;</div><div class="line"> 　　　　　 return xhr;</div><div class="line"> 　　　 &#125;</div><div class="line"> 　 &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<blockquote>
<p>下载进度条实现</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">xhr.onprogress = downloadProgress;</div><div class="line">function downloadProgress(event) &#123;//未测试</div><div class="line">    if(event.lengthComputable) &#123;</div><div class="line">        var percentComplete = event.loaded / event.total; </div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/XMLHttpRequest/">XMLHttpRequest</a>
    </span>
    

    </div>

    
  </div>
</article>


    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2017 yangyangyang
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>